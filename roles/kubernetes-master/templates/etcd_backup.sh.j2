#!/bin/bash
# Etcd Backup Script - Managed by Ansible

BACKUP_DIR="{{ backup_dir }}"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/etcd_backup_${DATE}.db"
RETENTION_DAYS={{ backup_retention_days }}

# Create backup directory
mkdir -p ${BACKUP_DIR}

# Backup etcd
ETCDCTL_API=3 etcdctl snapshot save ${BACKUP_FILE} \
  --endpoints=127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# Remove old backups
find ${BACKUP_DIR} -name "etcd_backup_*.db" -mtime +${RETENTION_DAYS} -delete

# Log
echo "$(date '+%Y-%m-%d %H:%M:%S') - Backup completed: ${BACKUP_FILE}" >> /var/log/etcd_backup.log

# Verify backup
if [ -f "${BACKUP_FILE}" ]; then
    SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Backup size: ${SIZE}" >> /var/log/etcd_backup.log
else
    echo "$(date '+%Y-%m-%d %H:%M:%S') - ERROR: Backup failed!" >> /var/log/etcd_backup.log
    exit 1
fi
